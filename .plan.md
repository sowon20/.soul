# 검색 시스템 개선 플랜

## 현재 문제

1. **사용자 검색창**: 레거시 JSONL 읽음 → 빈 결과 (대화는 Archiver JSON에 저장)
2. **AI recall_memory**: 벡터 검색 커버리지 7% (오늘 428개 중 29개만 임베딩)
3. **Archiver.searchByKeywords()**: 잘 동작하지만 아무 데서도 안 쓰임

## 해결: FTS5 기반 하이브리드 검색

### 핵심 아이디어
- **FTS5** (SQLite 내장 전문검색) → 모든 메시지 즉시 키워드 검색 (API 비용 0원)
- **벡터 검색** → 의미 기반 보조 검색 (기존 일배치 유지)
- **통합 SearchEngine** → 사용자 검색창 + AI recall_memory 동일 엔진

### 데이터 흐름 (변경 후)
```
메시지 저장:
  conversation-pipeline → archiver.archiveMessage()
    → JSON 파일 저장 (기존)
    → FTS5 INSERT (추가, sub-ms)

검색:
  SearchEngine.search(query, options)
    → [병렬] FTS5 MATCH + 벡터 검색 + soul_memories
    → 중복 제거 + 점수 합산 + 정렬
```

## 구현 순서

### Step 1: FTS5 테이블 생성
**파일**: `soul/db/sqlite.js` (createTables 함수, 484줄 뒤)
- `messages_fts` 가상 테이블 추가
- 컬럼: content, role(UNINDEXED), tags, source_date(UNINDEXED), timestamp(UNINDEXED)
- tokenizer: unicode61 (한국어 지원)

### Step 2: 실시간 FTS 인덱싱
**파일**: `soul/utils/conversation-archiver.js`
- `_indexToFTS(entry)` 메서드 추가
- `_saveToRemote()` 325줄 뒤에서 호출
- `_saveToLocalCache()` 에서도 호출
- API 호출 없음, SQLite INSERT만 (sub-ms)

### Step 3: 기존 데이터 백필
**파일**: `soul/utils/fts-backfill.js` (신규)
- 서버 시작 시 FTS5가 비어있으면 실행
- Archiver의 JSON 파일들을 읽어서 FTS5에 일괄 INSERT
- 2,493개 메시지 → 2초 이내 완료
- 트랜잭션 사용 (안전 + 빠름)

**파일**: `soul/server/index.js` (171줄 뒤)
- 백필 트리거 추가

### Step 4: 통합 검색 엔진
**파일**: `soul/utils/search-engine.js` (신규)
- `SearchEngine.search(query, options)` 메서드
- 3개 경로 병렬 실행:
  - Path 0: soul_memories LIKE 검색 (score 0.90~0.95)
  - Path 1: FTS5 BM25 검색 (score 0.50~0.85, 100% 커버리지)
  - Path 2: 벡터 코사인 유사도 (score 0.25~0.85, 부분 커버리지)
- 중복 제거 (content prefix 80자 기준)
- 시간 필터 지원 (parseTimeFilter 재사용)

### Step 5: 사용자 검색창 연결
**파일**: `soul/routes/search.js`
- `POST /api/search/smart` 핸들러에서 SearchEngine 사용
- 기존 `searchUtils.smartSearch()` 대체

### Step 6: AI recall_memory 연결
**파일**: `soul/utils/builtin-tools.js`
- `recallMemory()` 함수에서 SearchEngine 사용
- 기존 4경로 로직 대체 (SearchEngine이 동일한 역할)

## 변경 파일 요약

| 파일 | 변경 |
|------|------|
| `soul/db/sqlite.js` | FTS5 테이블 CREATE |
| `soul/utils/conversation-archiver.js` | `_indexToFTS()` 추가 |
| `soul/utils/fts-backfill.js` | **신규** - 기존 데이터 백필 |
| `soul/utils/search-engine.js` | **신규** - 통합 검색 엔진 |
| `soul/server/index.js` | 백필 트리거 추가 |
| `soul/routes/search.js` | smart 검색 핸들러 교체 |
| `soul/utils/builtin-tools.js` | recallMemory → SearchEngine 위임 |

## 건드리지 않는 것
- 벡터 검색 / 임베딩 스케줄러 (기존 유지)
- JSON 아카이브 구조 (기존 유지)
- conversation-store.js (레거시, 다른 곳에서 아직 사용)
